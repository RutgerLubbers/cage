# Homebrew Distribution Guide

This guide covers how to distribute Cage via Homebrew using a custom tap.

## Overview

Cage is distributed as a **Homebrew Formula** (not a Cask) because:
- It's a command-line tool built from source or distributed as a binary
- Casks are for macOS GUI applications (`.app` bundles, `.dmg`, `.pkg`)
- Formulas support both Intel and Apple Silicon via GoReleaser

## Setting Up Your Tap

### 1. Create the Tap Repository

Create a new GitHub repository named `homebrew-tap`:

```bash
# The repo must be named homebrew-tap for the shorthand to work
# e.g., gh repo create yourusername/homebrew-tap --public
```

This allows users to install with:
```bash
brew tap yourusername/tap
brew install cage
```

### 2. Repository Structure

Your tap repository should have this structure:

```
homebrew-tap/
├── Formula/
│   └── cage.rb          # Auto-generated by GoReleaser
└── README.md
```

GoReleaser will automatically create and update `Formula/cage.rb` on each release.

## GoReleaser Configuration

### Formula Configuration

Add to your `.goreleaser.yaml`:

```yaml
brews:
  - # GitHub repository to push the formula to
    repository:
      owner: yourusername
      name: homebrew-tap
      branch: main
      token: "{{ .Env.HOMEBREW_TAP_TOKEN }}"

    # Git author for formula updates
    commit_author:
      name: Your Name
      email: you@example.com

    commit_msg_template: "Brew formula update for {{ .ProjectName }} version {{ .Tag }}"

    # Folder inside the repository
    directory: Formula

    # Your project's homepage
    homepage: "https://github.com/yourusername/cage"

    # Description shown in `brew info`
    description: "Cross-platform sandbox CLI for restricting filesystem access"

    # License identifier
    license: "Apache-2.0"

    # Skip upload if this is a pre-release
    skip_upload: auto

    # Dependencies (if any)
    # dependencies:
    #   - name: go
    #     type: build

    # Custom install script (optional)
    # install: |
    #   bin.install "cage"

    # Test block to verify installation
    test: |
      system "#{bin}/cage", "--version"
```

### Complete Example

Here's a complete `.goreleaser.yaml` for Cage:

```yaml
version: 2

builds:
  - env:
      - CGO_ENABLED=0
    goos:
      - linux
      - darwin
    goarch:
      - amd64
      - arm64

release:
  mode: keep-existing

archives:
  - formats: [tar.gz]
    name_template: >-
      {{ .ProjectName }}_
      {{- title .Os }}_
      {{- if eq .Arch "amd64" }}x86_64
      {{- else if eq .Arch "386" }}i386
      {{- else }}{{ .Arch }}{{ end }}
      {{- if .Arm }}v{{ .Arm }}{{ end }}

brews:
  - repository:
      owner: yourusername
      name: homebrew-tap
      branch: main
      token: "{{ .Env.HOMEBREW_TAP_TOKEN }}"

    commit_author:
      name: Your Name
      email: you@example.com

    commit_msg_template: "Brew formula update for {{ .ProjectName }} version {{ .Tag }}"
    directory: Formula
    homepage: "https://github.com/yourusername/cage"
    description: "Cross-platform sandbox CLI for restricting filesystem access"
    license: "Apache-2.0"
    skip_upload: auto

    test: |
      system "#{bin}/cage", "--version"
```

## GitHub Actions Setup

### 1. Create a Personal Access Token

1. Go to GitHub → Settings → Developer settings → Personal access tokens → Fine-grained tokens
2. Create a token with:
   - **Repository access**: Only select repositories → select your `homebrew-tap` repo
   - **Permissions**: Contents (Read and write)
3. Copy the token

### 2. Add the Token as a Secret

1. Go to your `cage` repository → Settings → Secrets and variables → Actions
2. Add a new secret named `HOMEBREW_TAP_TOKEN` with the token value

### 3. Release Workflow

Your release workflow should pass the token to GoReleaser:

```yaml
# .github/workflows/release.yml
name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-go@v5
        with:
          go-version: stable

      - uses: goreleaser/goreleaser-action@v6
        with:
          distribution: goreleaser
          version: latest
          args: release --clean
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          HOMEBREW_TAP_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
```

## macOS Code Signing Considerations

### The Quarantine Problem

When users download binaries from the internet, macOS marks them with a quarantine flag. Unsigned binaries will show:

> "cage" cannot be opened because the developer cannot be verified.

### Solutions

#### Option 1: Users Remove Quarantine (No Cost)

Document this for users:

```bash
# After installation, remove quarantine
xattr -d com.apple.quarantine $(which cage)
```

Or in your formula:

```ruby
def caveats
  <<~EOS
    If you see "cannot be opened because the developer cannot be verified":
      xattr -d com.apple.quarantine #{bin}/cage
  EOS
end
```

#### Option 2: Ad-Hoc Signing (No Cost)

Sign binaries during the GoReleaser build. This removes the "unidentified developer" warning but still shows Gatekeeper prompts:

```yaml
# .goreleaser.yaml
signs:
  - cmd: codesign
    args:
      - --force
      - --sign
      - "-"  # Ad-hoc signature
      - "${artifact}"
    artifacts: binary
```

Note: This only works when building on macOS.

#### Option 3: Apple Developer ID (Paid)

For a fully seamless experience:
1. Join the Apple Developer Program ($99/year)
2. Create a "Developer ID Application" certificate
3. Sign and notarize binaries

This is typically overkill for open-source CLI tools.

### Recommended Approach

For most projects, document the quarantine removal in your README and formula caveats. Users of Homebrew taps are typically comfortable with this.

## Testing Locally

### Test GoReleaser Config

```bash
# Validate configuration
goreleaser check

# Do a local release (without publishing)
goreleaser release --snapshot --clean
```

### Test Formula Locally

After a release, test the formula:

```bash
# Tap your repository
brew tap yourusername/tap

# Install
brew install cage

# Verify
cage --version

# If quarantine issues on macOS:
xattr -d com.apple.quarantine $(which cage)
```

## Troubleshooting

### Formula Not Updating

1. Check GitHub Actions logs for the release job
2. Verify `HOMEBREW_TAP_TOKEN` has write access to the tap repo
3. Check if `skip_upload: auto` is skipping pre-releases

### Wrong Binary Architecture

Ensure your GoReleaser config includes both architectures:

```yaml
builds:
  - goos:
      - darwin
      - linux
    goarch:
      - amd64
      - arm64
```

### Token Permission Errors

The fine-grained token needs:
- **Contents**: Read and write (to push formula updates)
- Repository access limited to `homebrew-tap` only

### Homebrew Audit Warnings

Run `brew audit --strict cage` to check for formula issues. Common fixes:
- Add `license` field
- Add `test` block
- Ensure `description` doesn't start with article or project name

## Alternative: Homebrew Core

For wider distribution, you can submit to `homebrew-core`:
1. Must be a notable/popular project
2. Binary-only formulas are discouraged
3. Requires building from source
4. Review process can take weeks

For most projects, a custom tap is simpler and gives you full control.
